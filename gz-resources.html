<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<dom-module id="gz-resources">
  <template>
    <style>

    </style>

    <iron-ajax
      id="ajaxgetall"
      method="GET"
      url=[[url]]/[[resourcename]]s
      handle-as="json"
      on-response="_getAllResponse"
      on-error="_getAllError"
      content-type="application/json"
      debounce-duration="300"
    ></iron-ajax>

    <iron-ajax
      id="ajaxcreate"
      method="POST"
      url=[[url]]/[[resourcename]]s
      handle-as="json"
      on-response="_createResponse"
      on-error="_createError"
      content-type="application/json"
      debounce-duration="300"
    ></iron-ajax>

    <iron-ajax
      id="ajaxdelete"
      method="DELETE"
      url=[[url]]/[[resourcename]]s/[[deleteid]]
      handle-as="json"
      on-response="_deleteResponse"
      on-error="_deleteError"
      content-type="application/json"
      debounce-duration="300"
    ></iron-ajax>

    <div id="config" hidden$="[[!config]]">

      <div>
        <input value="{{url::input}}" placeholder="Cloudsim-auth server url"></input>
      </div>
      <div>
        <input value="{{token::input}}" placeholder="User token"></input>
      </div>
      <div>
        <input value="{{resourcename::input}}" placeholder="Resource name"></input>
      </div>

      <hr>

      <h3>Get all "[[resourcename]]"s for the user</h3>

      <button on-tap="getAll" >Get all [[resourcename]]s</button>

      <template is="dom-repeat" items="[[resources]]">
        <div>
          <button on-tap="_tapDelete" id="[[item.name]]" alt="Delete [[resourcename]]">X</button>
          [[item.data.name]]
        </div>
      </template>

      <hr>

      <h3>Create "[[resourcename]]"</h3>

      <div>
        <input id="datatxt" value="{{datatxt::input}}" placeholder="Data (json)"></input>
      </div>

      <button on-tap="_tapCreate" >Create [[resourcename]]</button>

      <hr>

    </div>

  </template>

  <!-- For optimal results, the version here should match the
       socket.io version in cloudsim-grant
  -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.js"></script>

  <script>


  (function() {
    'use strict';

    Polymer({
      is: 'gz-resources',

      /// Callback when component is attached.
      attached: function() {
        console.log('gz-resources widget attached (id = ' + this.id + ')')
        this.socket = null
      },

      /// Create a websocket connection to get feedback on resource changes
      connect: function() {
        if (this.socket) {
          try {
            this.socket.disconnect()
          }
          catch (err) {
            console.error(err)
          }
        }
        this.socket = io(this.url, {query: {token: this.token}})

        // avoid 'this' being reassign inside callbacks
        const socket = this.socket
        const msg = this.id + ' <gz-resources>:'

        socket.on('connect', _ => {
          console.log( msg, 'socket connected')
        })
        socket.on('error', function (e) {
          console.error(msg, error )
        })
        socket.on('disconnect', ()=>{
          console.error(msg, 'socket disconnect')
        })
        socket.on('reconnect', (n)=>{
          console.log(msg, 'socket reconnect','nb:', n)
        })
        socket.on('reconnect_attempt', ()=>{
          console.log(msg, 'reconnect_attempt')
        })
        socket.on('reconnecting', (n)=>{
          console.log(msg, 'socket reconnecting, nb:', n)
        })
        socket.on('reconnect_error',  function(err) {
          console.error(msg, 'socket reconnect error ' + util.inspect(err))
        })
        client.on('resource', function(resource) {
          this.fire('resource', res)
        })
      },

      /// Get all
      /// Get all resources for user
      getAll: function(req) {
        this.$.ajaxgetall.headers.authorization = this.token.trim()
        this.$.ajaxgetall.generateRequest()
        console.log(this.$.ajaxgetall.method,this.$.ajaxgetall.url, 'request sent')
      },


      /// Callback when successfully retrieving all resources
      _getAllResponse: function(req) {
        const resp = this.$.ajaxgetall.lastResponse
        console.log('_getAllResponse:', resp)
        if (!resp)
          return;

        if (!resp.success)
        {
          // ERROR
          return;
        }

        this.resources = resp.result;

        this.fire('resourcesupdated', this.resources)
      },

      /// Callback when failed to retrieve all resources
      _getAllError: function(err) {
        this._errorHelper(err, 'Failed to get ' + this.resourcename + 's')
      },

      /// Create resource
      /// Tap resource delete button on config
      _tapCreate: function(req) {
        try {
          this.data = JSON.parse(this.datatxt);
        }
        catch(e) {
          console.error("Couldn't parse json: " + e);
          return;
        }
        this.create();
      },

      /// Create a resource
      create: function(req) {
        this.$.ajaxcreate.headers.authorization = this.token.trim();
        this.$.ajaxcreate.body = this.data;
        this.$.ajaxcreate.generateRequest();
      },

      /// Callback when successfully creating resource.
      _createResponse: function(req) {
        const resp = this.$.ajaxcreate.lastResponse
        if (!resp)
          return;

        if (resp.success && resp.success == false)
        {
          console.error("Failed to create resource.");
          return;
        }

        // resp:
        // {
        //   id : String
        //   success : Boolean
        //   result
        //   {
        //     data
        //     {
        //     }
        //     permissions : Dictionary
        //     [username: String]
        //     {
        //       readOnly : Boolean
        //     }
        //   }
        // }
        this.fire('created', resp)
      },

      /// Callback when failed to create resource.
      _createError: function(err) {
        // No need to log this all the time, not necessarily an error, just
        // means user has no permissions
        // Message often is at: err.detail.error.message
        console.error(err)
      },

      /// Delete resource
      /// Tap resource delete button on config
      _tapDelete: function(req) {
        this.deleteid = req.target.id.trim();
        this.delete();
      },

      /// Callback when successfully creating resource.
      delete: function(req) {
        this.$.ajaxdelete.headers.authorization = this.token.trim();
        this.$.ajaxdelete.body = {};
        this.$.ajaxdelete.generateRequest();
      },

      /// Callback when successfully creating resource.
      _deleteResponse: function(req) {
        const resp = this.$.ajaxdelete.lastResponse
        if (!resp)
          return;

        if (resp.success && resp.success == false)
        {
          console.error("Failed to delete resource.");
          return;
        }

        // resp:
        // {
        //   success : Boolean
        //   resource
        //   {
        //     name : String
        //     data
        //     {
        //       name : String
        //     }
        //     permissions : Dictionary
        //     [username: String]
        //     {
        //       readOnly : Boolean
        //     }
        //   }
        // }
        this.fire('deleted', resp)
      },

      /// Callback when failed to delete resource.
      _deleteError: function(err) {
        console.error(err)
      },

      _errorHelper: function(err, msg) {
        let ajax = err.target
        if(!ajax) {
          console.error("ajax expected")
        }
        else{
          if(!ajax.lastError) {
            console.log("no lastError!")
          }
          else {
            if(!ajax.lastError.response) {
              if (err.detail.error.message) {
                msg += ": " + err.detail.error.message
              }
              else {
                msg += ": no response"
              }
            }
            else {
              // if there was a response, look for an object
              // with a message / error / msg attribute
              const res = ajax.lastError.response
              try {
                const json = typeof (res) === "object"? res: JSON.parse(res)
                if(json.error)
                  msg += ": " + json.error
                if(json.msg)
                  msg += ": " + json.msg
                if(json.message)
                  msg += ": " + json.message
              }
              catch(err) {
                // the error is not formatted as expected
                // add the entire response
                msg += ": " + res
              }
            }
          }
        }
        console.error(msg)
        this.fire('error', msg,  {bubbles: this.bubbles})
      },

      properties: {

        /// Show or hide the configuration UI
        config: {
          type: Boolean,
          value: false,
          notify: true
        },

        /// When true, error events bubble upstream
        bubbles: {
          type: Boolean,
          value: true
        },

        token: {
          type: String,
          value: '',
          notify: true
        },

        /// Server URL. This should point to a valid resource server
        url: {
          type: String,
          value: '',
          notify: true
        },


        /// the type of resource. For example, if this value is 'thing'
        /// then the resources will be fetched from /thing and /things
        /// routes on the server
        resourcename: {
          type: String,
          value: ''
        },

        /// The resources information are stored here. This is populated
        /// by the _
        resources: {
          type: Array,
          value: [],
          notify: true
        },

        /// Data used to create / update a resource.
        data: {
          type: Object,
          value: {},
          notify: true
        },
      }
    });
  })();
  </script>
</dom-module>
